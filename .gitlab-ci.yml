stages:
  - test
  - deploy

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
test:
  stage: test
  image: python:3.12
  before_script:
    - pip install -r requirements.txt
  script:
    - pytest
  tags:
    - staging

# –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
deploy:
  stage: deploy
  tags:
    - staging
  script:
    - echo "üì¶ –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞"
    - docker build -t taskmanager .

    - echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)"
    - docker stop taskmanager || true
    - docker rm taskmanager || true

    - echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
    - docker run -d --name taskmanager -p 8080:8080 taskmanager
  only:
    - main
