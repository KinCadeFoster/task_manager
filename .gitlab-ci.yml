variables:
  MODE: "DEV"

  DB_HOST: "192.168.1.122"
  DB_PORT: "5432"
  DB_USER: "postgres"
  DB_PASS: "dbpass123"
  DB_NAME: "cadefostdb"

  TEST_DB_HOST: "192.168.1.122"
  TEST_DB_PORT: "5432"
  TEST_DB_USER: "postgres"
  TEST_DB_PASS: "dbpass123"
  TEST_DB_NAME: "test_task_manager_db"

  SECRET_KEY: "aBVIDGPivNDXOLWK/GfDs7BNq21+INkcXoKF08GdR44="
  ALGORITHM: "HS256"

stages:
  - test
  - deploy

test:
  stage: test
  image: python:3.12
  tags:
    - docker
    - staging
  before_script:
    - apt-get update && apt-get install -y gcc libpq-dev
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - pytest

deploy:
  stage: deploy
  tags:
    - docker
    - staging
  script:
    - echo "üì¶ –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞"
    - docker build -t taskmanager .
    - echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)"
    - docker stop taskmanager || true
    - docker rm taskmanager || true
    - echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
    - docker run -d --name taskmanager -p 8080:8080 taskmanager
  only:
    - main
